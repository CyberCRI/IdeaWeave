/**
 * Copyright (C) 2010-2013 Graham Breach
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
/**
 * TagCanvas 2.2
 * For more information, please contact <graham@goat1000.com>
 */
(function(){var ao,an,aa=Math.abs,w=Math.sin,l=Math.cos,I=Math.max,at=Math.min,V=Math.ceil,ah=Math.sqrt,X=Math.pow,L={},O={},R={0:"0,",1:"17,",2:"34,",3:"51,",4:"68,",5:"85,",6:"102,",7:"119,",8:"136,",9:"153,",a:"170,",A:"170,",b:"187,",B:"187,",c:"204,",C:"204,",d:"221,",D:"221,",e:"238,",E:"238,",f:"255,",F:"255,"},e,ad,d,a,ae,z,o=document,H,c={};for(ao=0;ao<256;++ao){an=ao.toString(16);if(ao<16){an="0"+an}O[an]=O[an.toUpperCase()]=ao.toString()+","}function aj(i){return typeof i!="undefined"}function v(i){return typeof i=="object"&&i!=null}function b(i,j,av){return isNaN(i)?av:at(av,I(j,i))}function Y(){return false}function T(){return new Date().valueOf()}function n(av,ay){var j=[],aw=av.length,ax;for(ax=0;ax<aw;++ax){j.push(av[ax])}j.sort(ay);return j}function ac(j){var aw=j.length-1,av,ax;while(aw){ax=~~(Math.random()*aw);av=j[aw];j[aw]=j[ax];j[ax]=av;--aw}}function U(i,av,j){this.x=i;this.y=av;this.z=j}ae=U.prototype;ae.length=function(){return ah(this.x*this.x+this.y*this.y+this.z*this.z)};ae.dot=function(i){return this.x*i.x+this.y*i.y+this.z*i.z};ae.cross=function(j){var i=this.y*j.z-this.z*j.y,aw=this.z*j.x-this.x*j.z,av=this.x*j.y-this.y*j.x;return new U(i,aw,av)};ae.angle=function(j){var i=this.dot(j),av;if(i==0){return Math.PI/2}av=i/(this.length()*j.length());if(av>=1){return 0}if(av<=-1){return Math.PI}return Math.acos(av)};ae.unit=function(){var i=this.length();return new U(this.x/i,this.y/i,this.z/i)};function K(av,j){j=j*Math.PI/180;av=av*Math.PI/180;var i=w(av)*l(j),ax=-w(j),aw=-l(av)*l(j);return new U(i,ax,aw)}function k(i){this[1]={1:i[0],2:i[1],3:i[2]};this[2]={1:i[3],2:i[4],3:i[5]};this[3]={1:i[6],2:i[7],3:i[8]}}a=k.prototype;k.Identity=function(){return new k([1,0,0,0,1,0,0,0,1])};k.Rotation=function(aw,i){var j=w(aw),av=l(aw),ax=1-av;return new k([av+X(i.x,2)*ax,i.x*i.y*ax-i.z*j,i.x*i.z*ax+i.y*j,i.y*i.x*ax+i.z*j,av+X(i.y,2)*ax,i.y*i.z*ax-i.x*j,i.z*i.x*ax-i.y*j,i.z*i.y*ax+i.x*j,av+X(i.z,2)*ax])};a.mul=function(av){var aw=[],az,ay,ax=(av.xform?1:0);for(az=1;az<=3;++az){for(ay=1;ay<=3;++ay){if(ax){aw.push(this[az][1]*av[1][ay]+this[az][2]*av[2][ay]+this[az][3]*av[3][ay])}else{aw.push(this[az][ay]*av)}}}return new k(aw)};a.xform=function(av){var j={},i=av.x,ax=av.y,aw=av.z;j.x=i*this[1][1]+ax*this[2][1]+aw*this[3][1];j.y=i*this[1][2]+ax*this[2][2]+aw*this[3][2];j.z=i*this[1][3]+ax*this[2][3]+aw*this[3][3];return j};function s(aw,ay,aD,aA){var az,aC,j,aB,aE=[],ax=Math.PI*(3-ah(5)),av=2/aw;for(az=0;az<aw;++az){aC=az*av-1+(av/2);j=ah(1-aC*aC);aB=az*ax;aE.push([l(aB)*j*ay,aC*aD,w(aB)*j*aA])}return aE}function ar(ax,av,aA,aG,aE){var aF,aH=[],ay=Math.PI*(3-ah(5)),aw=2/ax,aD,aC,aB,az;for(aD=0;aD<ax;++aD){aC=aD*aw-1+(aw/2);aF=aD*ay;aB=l(aF);az=w(aF);aH.push(av?[aC*aA,aB*aG,az*aE]:[aB*aA,aC*aG,az*aE])}return aH}function Q(av,aw,az,aF,aD,aB){var aE,aG=[],ax=Math.PI*2/aw,aC,aA,ay;for(aC=0;aC<aw;++aC){aE=aC*ax;aA=l(aE);ay=w(aE);aG.push(av?[aB*az,aA*aF,ay*aD]:[aA*az,aB*aF,ay*aD])}return aG}function E(aw,i,j,av){return ar(aw,0,i,j,av)}function W(aw,i,j,av){return ar(aw,1,i,j,av)}function C(ax,i,j,av,aw){aw=isNaN(aw)?0:aw*1;return Q(0,ax,i,j,av,aw)}function N(ax,i,j,av,aw){aw=isNaN(aw)?0:aw*1;return Q(1,ax,i,j,av,aw)}function u(ay,i){var ax=ay,aw,av,j=(i*1).toPrecision(3)+")";if(ay[0]==="#"){if(!L[ay]){if(ay.length===4){L[ay]="rgba("+R[ay[1]]+R[ay[2]]+R[ay[3]]}else{L[ay]="rgba("+O[ay.substr(1,2)]+O[ay.substr(3,2)]+O[ay.substr(5,2)]}}ax=L[ay]+j}else{if(ay.substr(0,4)==="rgb("||ay.substr(0,4)==="hsl("){ax=(ay.replace("(","a(").replace(")",","+j))}else{if(ay.substr(0,5)==="rgba("||ay.substr(0,5)==="hsla("){aw=ay.lastIndexOf(",")+1,av=ay.indexOf(")");i*=parseFloat(ay.substring(aw,av));ax=ay.substr(0,aw)+i.toPrecision(3)+")"}}}return ax}function h(i,j){if(window.G_vmlCanvasManager){return null}var av=o.createElement("canvas");av.width=i;av.height=j;return av}function D(){var j=h(3,3),aw,av;if(!j){return false}aw=j.getContext("2d");aw.strokeStyle="#000";aw.shadowColor="#fff";aw.shadowBlur=3;aw.globalAlpha=0;aw.strokeRect(2,2,2,2);aw.globalAlpha=1;av=aw.getImageData(2,2,1,1);j=null;return(av.data[0]>0)}function au(aC,j){var av=1024,ay=aC.weightGradient,ax,aA,aw,aB,az;if(aC.gCanvas){aA=aC.gCanvas.getContext("2d")}else{aC.gCanvas=ax=h(av,1);if(!ax){return null}aA=ax.getContext("2d");aB=aA.createLinearGradient(0,0,av,0);for(aw in ay){aB.addColorStop(1-aw,ay[aw])}aA.fillStyle=aB;aA.fillRect(0,0,av,1)}az=aA.getImageData(~~((av-1)*j),0,1,1).data;return"rgba("+az[0]+","+az[1]+","+az[2]+","+(az[3]/255)+")"}function B(aA,az,aw,aG,aB,aC,av,aD,aE){var ay=(aC||0)+(av&&av[0]<0?aa(av[0]):0),j=(aC||0)+(av&&av[1]<0?aa(av[1]):0),ax,aF;aA.font=az;aA.textBaseline="top";aA.fillStyle=aw;aB&&(aA.shadowColor=aB);aC&&(aA.shadowBlur=aC);av&&(aA.shadowOffsetX=av[0],aA.shadowOffsetY=av[1]);for(ax=0;ax<aG.length;++ax){aF=aE?(aD-aE[ax])/2:0;aA.fillText(aG[ax],ay+aF,j);j+=parseInt(az)}}function q(aJ,aA,aF,aH,az,aw,aD,aE,j,aI,aG,aC,av){var ax=aH+aa(j[0])+aE+aE,i=az+aa(j[1])+aE+aE,ay,aB;ay=h(ax+aI,i+aG);if(!ay){return null}aB=ay.getContext("2d");B(aB,aA,aw,aJ,aD,aE,j,aC,av);return ay}function am(aA,aD,aE,aw){var aF=aa(aw[0]),aB=aa(aw[1]),ax=aA.width+(aF>aE?aF+aE:aE*2),j=aA.height+(aB>aE?aB+aE:aE*2),az=(aE||0)+(aw[0]<0?aF:0),av=(aE||0)+(aw[1]<0?aB:0),ay,aC;ay=h(ax,j);if(!ay){return null}aC=ay.getContext("2d");aD&&(aC.shadowColor=aD);aE&&(aC.shadowBlur=aE);aw&&(aC.shadowOffsetX=aw[0],aC.shadowOffsetY=aw[1]);aC.drawImage(aA,az,av,aA.width,aA.height);return ay}function af(aH,az,aF){var aG=parseInt(aH.toString().length*aF),ay=parseInt(aF*2*aH.length),aw=h(aG,ay),aC,j,ax,aB,aE,aD,av,aA;if(!aw){return null}aC=aw.getContext("2d");aC.fillStyle="#000";aC.fillRect(0,0,aG,ay);B(aC,aF+"px "+az,"#fff",aH,0,0,[]);j=aC.getImageData(0,0,aG,ay);ax=j.width;aB=j.height;aA={min:{x:ax,y:aB},max:{x:-1,y:-1}};for(aD=0;aD<aB;++aD){for(aE=0;aE<ax;++aE){av=(aD*ax+aE)*4;if(j.data[av+1]>0){if(aE<aA.min.x){aA.min.x=aE}if(aE>aA.max.x){aA.max.x=aE}if(aD<aA.min.y){aA.min.y=aD}if(aD>aA.max.y){aA.max.y=aD}}}}if(ax!=aG){aA.min.x*=(aG/ax);aA.max.x*=(aG/ax)}if(aB!=ay){aA.min.y*=(aG/aB);aA.max.y*=(aG/aB)}aw=null;return aA}function y(i){return"'"+i.replace(/(\'|\")/g,"").replace(/\s*,\s*/g,"', '")+"'"}function G(i,j,av){av=av||o;if(av.addEventListener){av.addEventListener(i,j,false)}else{av.attachEvent("on"+i,j)}}function al(ax,az,aw,av){var ay=av.imageScale,j;if(!az.complete){return G("load",function(){al(ax,az,aw,av)},az)}if(!ax.complete){return G("load",function(){al(ax,az,aw,av)},ax)}az.width=az.width;az.height=az.height;if(ay){ax.width=az.width*ay;ax.height=az.height*ay}aw.w=ax.width;aw.h=ax.height;if(av.txtOpt&&av.shadow){j=am(ax,av.shadow,av.shadowBlur,av.shadowOffset);if(j){aw.image=j;aw.w=j.width;aw.h=j.height}}}function ai(aw,av){var j=o.defaultView,i=av.replace(/\-([a-z])/g,function(ax){return ax.charAt(1).toUpperCase()});return(j&&j.getComputedStyle&&j.getComputedStyle(aw,null).getPropertyValue(av))||(aw.currentStyle&&aw.currentStyle[i])}function F(av,j){var i=1,aw;if(av.weightFrom){i=1*(j.getAttribute(av.weightFrom)||av.textHeight)}else{if(aw=ai(j,"font-size")){i=(aw.indexOf("px")>-1&&aw.replace("px","")*1)||(aw.indexOf("pt")>-1&&aw.replace("pt","")*1.25)||aw*3.3}else{av.weight=false}}return i}function A(i){return i.target&&aj(i.target.id)?i.target.id:i.srcElement.parentNode.id}function M(ax,ay){var aw,av,i=parseInt(ai(ay,"width"))/ay.width,j=parseInt(ai(ay,"height"))/ay.height;if(aj(ax.offsetX)){aw={x:ax.offsetX,y:ax.offsetY}}else{av=r(ay.id);if(aj(ax.changedTouches)){ax=ax.changedTouches[0]}if(ax.pageX){aw={x:ax.pageX-av.x,y:ax.pageY-av.y}}}if(aw&&i&&j){aw.x/=i;aw.y/=j}return aw}function m(av){var j=av.target||av.fromElement.parentNode,i=x.tc[j.id];if(i){i.mx=i.my=-1;i.UnFreeze();i.EndDrag()}}function ag(az){var aw,av=x,j,ay,ax=A(az);for(aw in av.tc){j=av.tc[aw];if(j.tttimer){clearTimeout(j.tttimer);j.tttimer=null}}if(ax&&av.tc[ax]){j=av.tc[ax];if(ay=M(az,j.canvas)){j.mx=ay.x;j.my=ay.y;j.Drag(az,ay)}j.drawn=0}}function Z(aw){var j=x,i=o.addEventListener?0:1,av=A(aw);if(av&&aw.button==i&&j.tc[av]){j.tc[av].BeginDrag(aw)}}function g(ax){var av=x,j=o.addEventListener?0:1,aw=A(ax),i;if(aw&&ax.button==j&&av.tc[aw]){i=av.tc[aw];ag(ax);if(!i.EndDrag()&&!i.touched){i.Clicked(ax)}}}function J(av){var i=x,j=A(av);if(j&&av.changedTouches&&i.tc[j]){i.tc[j].touched=1;i.tc[j].BeginDrag(av)}}function p(av){var i=x,j=A(av);if(j&&av.changedTouches&&i.tc[j]){ab(av);if(!i.tc[j].EndDrag()){i.tc[j].Draw();i.tc[j].Clicked(av)}}}function ab(az){var aw,av=x,j,ay,ax=A(az);for(aw in av.tc){j=av.tc[aw];if(j.tttimer){clearTimeout(j.tttimer);j.tttimer=null}}if(ax&&av.tc[ax]&&az.changedTouches){j=av.tc[ax];if(ay=M(az,j.canvas)){j.mx=ay.x;j.my=ay.y;j.Drag(az,ay)}j.drawn=0}}function aq(av){var i=x,j=A(av);if(j&&i.tc[j]){av.cancelBubble=true;av.returnValue=false;av.preventDefault&&av.preventDefault();i.tc[j].Wheel((av.wheelDelta||av.detail)>0)}}function t(ax){var j=x.tc,aw,av;ax=ax||T();for(aw in j){av=j[aw].interval;j[aw].Draw(ax)}x.NextFrame(av)}function r(av){var ay=o.getElementById(av),i=ay.getBoundingClientRect(),aB=o.documentElement,az=o.body,aA=window,aw=aA.pageXOffset||aB.scrollLeft,aC=aA.pageYOffset||aB.scrollTop,ax=aB.clientLeft||az.clientLeft,j=aB.clientTop||az.clientTop;return{x:i.left+aw-ax,y:i.top+aC-j}}function ap(j,aw,ax,av){var i=j.radius*j.z1/(j.z1+j.z2+aw.z);return{x:aw.x*i*ax,y:aw.y*i*av,z:aw.z,w:(j.z1-aw.z)/j.z2}}function P(i){this.e=i;this.br=0;this.line=[];this.text=[];this.original=i.innerText||i.textContent}z=P.prototype;z.Lines=function(ax){var aw=ax?1:0,ay,j,av;ax=ax||this.e;ay=ax.childNodes;j=ay.length;for(av=0;av<j;++av){if(ay[av].nodeName=="BR"){this.text.push(this.line.join(" "));this.br=1}else{if(ay[av].nodeType==3){if(this.br){this.line=[ay[av].nodeValue];this.br=0}else{this.line.push(ay[av].nodeValue)}}else{this.Lines(ay[av])}}}aw||this.br||this.text.push(this.line.join(" "));return this.text};z.SplitWidth=function(av,aC,az,ay){var ax,aw,aB,aA=[];aC.font=ay+"px "+az;for(ax=0;ax<this.text.length;++ax){aB=this.text[ax].split(/\s+/);this.line=[aB[0]];for(aw=1;aw<aB.length;++aw){if(aC.measureText(this.line.join(" ")+" "+aB[aw]).width>av){aA.push(this.line.join(" "));this.line=[aB[aw]]}else{this.line.push(aB[aw])}}aA.push(this.line.join(" "))}return this.text=aA};function f(i){this.ts=T();this.tc=i;this.x=this.y=this.w=this.h=this.sc=1;this.z=0;this.Draw=i.pulsateTo<1&&i.outlineMethod!="colour"?this.DrawPulsate:this.DrawSimple;this.SetMethod(i.outlineMethod)}e=f.prototype;e.SetMethod=function(av){var j={block:["PreDraw","DrawBlock"],colour:["PreDraw","DrawColour"],outline:["PostDraw","DrawOutline"],classic:["LastDraw","DrawOutline"],none:["LastDraw"]},i=j[av]||j.outline;if(av=="none"){this.Draw=function(){return 1}}else{this.drawFunc=this[i[1]]}this[i[0]]=this.Draw};e.Update=function(aB,aA,aC,ax,ay,az,aw,i){var j=this.tc.outlineOffset,av=2*j;this.x=ay*aB+aw-j;this.y=ay*aA+i-j;this.w=ay*aC+av;this.h=ay*ax+av;this.sc=ay;this.z=az};e.DrawOutline=function(ay,i,ax,j,av,aw){ay.strokeStyle=aw;ay.strokeRect(i,ax,j,av)};e.DrawColour=function(aw,az,ax,aA,av,i,aB,j,ay){return this[aB.image?"DrawColourImage":"DrawColourText"](aw,az,ax,aA,av,i,aB,j,ay)};e.DrawColourText=function(ax,aA,ay,aB,av,i,aC,j,az){var aw=aC.colour;aC.colour=i;aC.alpha=1;aC.Draw(ax,j,az);aC.colour=aw;return 1};e.DrawColourImage=function(aA,aD,aB,aE,az,i,aH,j,aC){var aF=aA.canvas,ax=~~I(aD,0),aw=~~I(aB,0),ay=at(aF.width-ax,aE)+0.5|0,aG=at(aF.height-aw,az)+0.5|0,av;if(H){H.width=ay,H.height=aG}else{H=h(ay,aG)}if(!H){return this.SetMethod("outline")}av=H.getContext("2d");av.drawImage(aF,ax,aw,ay,aG,0,0,ay,aG);aA.clearRect(ax,aw,ay,aG);aH.alpha=1;aH.Draw(aA,j,aC);aA.setTransform(1,0,0,1,0,0);aA.save();aA.beginPath();aA.rect(ax,aw,ay,aG);aA.clip();aA.globalCompositeOperation="source-in";aA.fillStyle=i;aA.fillRect(ax,aw,ay,aG);aA.restore();aA.globalCompositeOperation="destination-over";aA.drawImage(H,0,0,ay,aG,ax,aw,ay,aG);aA.globalCompositeOperation="source-over";return 1};e.DrawBlock=function(ay,i,ax,j,av,aw){ay.fillStyle=aw;ay.fillRect(i,ax,j,av)};e.DrawSimple=function(ax,i,j,aw){var av=this.tc;ax.setTransform(1,0,0,1,0,0);ax.strokeStyle=av.outlineColour;ax.lineWidth=av.outlineThickness;ax.shadowBlur=ax.shadowOffsetX=ax.shadowOffsetY=0;ax.globalAlpha=1;return this.drawFunc(ax,this.x,this.y,this.w,this.h,av.outlineColour,i,j,aw)};e.DrawPulsate=function(ay,i,j,aw){var ax=T()-this.ts,av=this.tc;ay.setTransform(1,0,0,1,0,0);ay.strokeStyle=av.outlineColour;ay.lineWidth=av.outlineThickness;ay.shadowBlur=ay.shadowOffsetX=ay.shadowOffsetY=0;ay.globalAlpha=av.pulsateTo+((1-av.pulsateTo)*(0.5+(l(2*Math.PI*ax/(1000*av.pulsateTime))/2)));return this.drawFunc(ay,this.x,this.y,this.w,this.h,av.outlineColour,i,j,aw)};e.Active=function(av,i,j){return(i>=this.x&&j>=this.y&&i<=this.x+this.w&&j<=this.y+this.h)};e.PreDraw=e.PostDraw=e.LastDraw=Y;function S(aw,aC,az,aB,aA,ax,j,av,i){var ay=aw.ctxt;this.tc=aw;this.image=aC.src?aC:null;this.text=aC.src?[]:aC;this.text_original=i;this.line_widths=[];this.title=az.title||null;this.a=az;this.position=new U(aB[0],aB[1],aB[2]);this.x=this.y=this.z=0;this.w=aA;this.h=ax;this.colour=j||aw.textColour;this.textFont=av||aw.textFont;this.weight=this.sc=this.alpha=1;this.weighted=!aw.weight;this.outline=new f(aw);if(!this.image){this.textHeight=aw.textHeight;this.extents=af(this.text,this.textFont,this.textHeight);this.Measure(ay,aw)}this.SetShadowColour=aw.shadowAlpha?this.SetShadowColourAlpha:this.SetShadowColourFixed;this.SetDraw(aw)}ad=S.prototype;ad.EqualTo=function(av){var j=av.getElementsByTagName("img");if(this.a.href!=av.href){return 0}if(j.length){return this.image.src==j[0].src}return(av.innerText||av.textContent)==this.text_original};ad.SetDraw=function(i){this.Draw=this.image?(i.ie>7?this.DrawImageIE:this.DrawImage):this.DrawText;i.noSelect&&(this.CheckActive=Y)};ad.MeasureText=function(ay){var aw,av=this.text.length,j=0,ax;for(aw=0;aw<av;++aw){this.line_widths[aw]=ax=ay.measureText(this.text[aw]).width;j=I(j,ax)}return j};ad.Measure=function(az,j){this.h=this.extents?this.extents.max.y+this.extents.min.y:this.textHeight;az.font=this.font=this.textHeight+"px "+this.textFont;this.w=this.MeasureText(az);if(j.txtOpt){var aw=j.txtScale,ax=aw*this.textHeight,ay=ax+"px "+this.textFont,av=[aw*j.shadowOffset[0],aw*j.shadowOffset[1]],i;az.font=ay;i=this.MeasureText(az);this.image=q(this.text,ay,ax,i,aw*this.h,this.colour,j.shadow,aw*j.shadowBlur,av,aw,aw,i,this.line_widths);if(this.image){this.w=this.image.width/aw;this.h=this.image.height/aw}this.SetDraw(j);j.txtOpt=!!this.image}};ad.SetFont=function(i,j){this.textFont=i;this.colour=j;this.extents=af(this.text,this.textFont,this.textHeight);this.Measure(this.tc.ctxt,this.tc)};ad.SetWeight=function(i){if(!this.text.length){return}this.weight=i;this.Weight(this.tc.ctxt,this.tc);this.Measure(this.tc.ctxt,this.tc)};ad.Weight=function(aw,av){var j=this.weight,i=av.weightMode;this.weighted=true;if(i=="colour"||i=="both"){this.colour=au(av,(j-av.min_weight)/(av.max_weight-av.min_weight))}if(i=="size"||i=="both"){if(av.weightSizeMin>0&&av.weightSizeMax>av.weightSizeMin){this.textHeight=av.weightSize*(av.weightSizeMin+(av.weightSizeMax-av.weightSizeMin)*(j-av.min_weight)/(av.max_weight-av.min_weight))}else{this.textHeight=j*av.weightSize}}this.extents=af(this.text,this.textFont,this.textHeight)};ad.SetShadowColourFixed=function(av,j,i){av.shadowColor=j};ad.SetShadowColourAlpha=function(av,j,i){av.shadowColor=u(j,i)};ad.DrawText=function(ax,aA,aw){var aB=this.tc,az=this.x,ay=this.y,aC=this.sc,j,av;ax.globalAlpha=this.alpha;ax.fillStyle=this.colour;aB.shadow&&this.SetShadowColour(ax,aB.shadow,this.alpha);ax.font=this.font;az+=aA/aC;ay+=(aw/aC)-(this.h/2);for(j=0;j<this.text.length;++j){av=az-(this.line_widths[j]/2);ax.setTransform(aC,0,0,aC,aC*av,aC*ay);ax.fillText(this.text[j],0,0);ay+=this.textHeight}};ad.DrawImage=function(ax,aD,aw){var aA=this.x,ay=this.y,aE=this.sc,j=this.image,aB=this.w,av=this.h,az=this.alpha,aC=this.shadow;ax.globalAlpha=az;aC&&this.SetShadowColour(ax,aC,az);aA+=(aD/aE)-(aB/2);ay+=(aw/aE)-(av/2);ax.setTransform(aE,0,0,aE,aE*aA,aE*ay);ax.drawImage(j,0,0,aB,av)};ad.DrawImageIE=function(ax,aB,aw){var j=this.image,aC=this.sc,aA=j.width=this.w*aC,av=j.height=this.h*aC,az=(this.x*aC)+aB-(aA/2),ay=(this.y*aC)+aw-(av/2);ax.setTransform(1,0,0,1,0,0);ax.globalAlpha=this.alpha;ax.drawImage(j,az,ay)};ad.Calc=function(i,av){var j,ay=this.tc,ax=ay.minBrightness,aw=ay.maxBrightness,az=ay.max_radius;j=i.xform(this.position);this.xformed=j;j=ap(ay,j,ay.stretchX,ay.stretchY);this.x=j.x;this.y=j.y;this.z=j.z;this.sc=j.w;this.alpha=av*b(ax+(aw-ax)*(az-this.z)/(2*az),0,1)};ad.CheckActive=function(aw,aA,av){var aB=this.tc,i=this.outline,az=this.w,j=this.h,ay=this.x-az/2,ax=this.y-j/2;i.Update(ay,ax,az,j,this.sc,this.z,aA,av);return i.Active(aw,aB.mx,aB.my)?i:null};ad.Clicked=function(ay){var j=this.a,av=j.target,aw=j.href,i;if(av!=""&&av!="_self"){if(self.frames[av]){self.frames[av].document.location=aw}else{try{if(top.frames[av]){top.frames[av].document.location=aw;return}}catch(ax){}window.open(aw,av)}return}if(o.createEvent){i=o.createEvent("MouseEvents");i.initMouseEvent("click",1,1,window,0,0,0,0,0,0,0,0,0,0,null);if(!j.dispatchEvent(i)){return}}else{if(j.fireEvent){if(!j.fireEvent("onclick")){return}}}o.location=aw};function x(aA,j,aw){var av,ay,az=o.getElementById(aA),ax=["id","class","innerHTML"];if(!az){throw 0}if(aj(window.G_vmlCanvasManager)){az=window.G_vmlCanvasManager.initElement(az);this.ie=parseFloat(navigator.appVersion.split("MSIE")[1])}if(az&&(!az.getContext||!az.getContext("2d").fillText)){ay=o.createElement("DIV");for(av=0;av<ax.length;++av){ay[ax[av]]=az[ax[av]]}az.parentNode.insertBefore(ay,az);az.parentNode.removeChild(az);throw 0}for(av in x.options){this[av]=aw&&aj(aw[av])?aw[av]:(aj(x[av])?x[av]:x.options[av])}this.canvas=az;this.ctxt=az.getContext("2d");this.z1=250/this.depth;this.z2=this.z1/this.zoom;this.radius=at(az.height,az.width)*0.0075;this.max_weight=0;this.min_weight=200;this.textFont=this.textFont&&y(this.textFont);this.textHeight*=1;this.pulsateTo=b(this.pulsateTo,0,1);this.minBrightness=b(this.minBrightness,0,1);this.maxBrightness=b(this.maxBrightness,this.minBrightness,1);this.ctxt.textBaseline="top";this.lx=(this.lock+"").indexOf("x")+1;this.ly=(this.lock+"").indexOf("y")+1;this.frozen=this.dx=this.dy=this.fixedAnim=this.touched=0;this.fixedAlpha=1;this.source=j||aA;this.transform=k.Identity();this.startTime=this.time=T();this.Animate=this.dragControl?this.AnimateDrag:this.AnimatePosition;this.animTiming=(typeof x[this.animTiming]=="function"?x[this.animTiming]:x.Smooth);if(this.shadowBlur||this.shadowOffset[0]||this.shadowOffset[1]){this.ctxt.shadowColor=this.shadow;this.shadow=this.ctxt.shadowColor;this.shadowAlpha=D()}else{delete this.shadow}this.Load();if(j&&this.hideTags){(function(i){if(x.loaded){i.HideTags()}else{G("load",function(){i.HideTags()},window)}})(this)}this.yaw=this.initial?this.initial[0]*this.maxSpeed:0;this.pitch=this.initial?this.initial[1]*this.maxSpeed:0;if(this.tooltip){if(this.tooltip=="native"){this.Tooltip=this.TooltipNative}else{this.Tooltip=this.TooltipDiv;if(!this.ttdiv){this.ttdiv=o.createElement("div");this.ttdiv.className=this.tooltipClass;this.ttdiv.style.position="absolute";this.ttdiv.style.zIndex=az.style.zIndex+1;G("mouseover",function(i){i.target.style.display="none"},this.ttdiv);o.body.appendChild(this.ttdiv)}}}else{this.Tooltip=this.TooltipNone}if(!this.noMouse&&!c[aA]){G("mousemove",ag,az);G("mouseout",m,az);G("mouseup",g,az);G("touchstart",J,az);G("touchend",p,az);G("touchcancel",p,az);G("touchmove",ab,az);if(this.dragControl){G("mousedown",Z,az);G("selectstart",Y,az)}if(this.wheelZoom){G("mousewheel",aq,az);G("DOMMouseScroll",aq,az)}c[aA]=1}x.started||(x.started=setTimeout(t,this.interval))}d=x.prototype;d.SourceElements=function(){if(o.querySelectorAll){return o.querySelectorAll("#"+this.source)}return[o.getElementById(this.source)]};d.HideTags=function(){var av=this.SourceElements(),j;for(j=0;j<av.length;++j){av[j].style.display="none"}};d.GetTags=function(){var az=this.SourceElements(),ay,av=[],ax,aw;for(ax=0;ax<az.length;++ax){ay=az[ax].getElementsByTagName("a");for(aw=0;aw<ay.length;++aw){av.push(ay[aw])}}return av};d.CreateTag=function(aA,az){var j=aA.getElementsByTagName("img"),ax,aw,ay,av;az=az||[0,0,0];if(j.length){ax=new Image;ax.src=j[0].src;aw=new S(this,ax,aA,az,0,0);al(ax,j[0],aw,this);return aw}ay=new P(aA);aw=ay.Lines();av=this.textFont||y(ai(aA,"font-family"));if(this.splitWidth){aw=ay.SplitWidth(this.splitWidth,this.ctxt,av,this.textHeight)}return new S(this,aw,aA,az,2,this.textHeight+2,this.textColour||ai(aA,"color"),av,ay.original)};d.UpdateTag=function(av,i){var aw=this.textColour||ai(i,"color"),j=this.textFont||y(ai(i,"font-family"));av.title=i.title;if(av.colour!=aw||av.textFont!=j){av.SetFont(j,aw)}};d.Weight=function(aw){var av=aw.length,j,ax,ay=[];for(ax=0;ax<av;++ax){j=F(this,aw[ax].a);if(j>this.max_weight){this.max_weight=j}if(j<this.min_weight){this.min_weight=j}ay.push(j)}if(this.max_weight>this.min_weight){for(ax=0;ax<av;++ax){aw[ax].SetWeight(ay[ax])}}};d.Load=function(){var aE=this.GetTags(),aA=[],aD,az,aw,av,j,ax,aC,ay=[],aB={sphere:s,vcylinder:E,hcylinder:W,vring:C,hring:N};if(aE.length){ay.length=aE.length;for(aC=0;aC<aE.length;++aC){ay[aC]=aC}this.shuffleTags&&ac(ay);aw=100*this.radiusX;av=100*this.radiusY;j=100*this.radiusZ;this.max_radius=I(aw,I(av,j));if(this.shapeArgs){this.shapeArgs[0]=aE.length}else{az=this.shape.toString().split(/[(),]/);aD=az.shift();this.shape=aB[aD]||aB.sphere;this.shapeArgs=[aE.length,aw,av,j].concat(az)}ax=this.shape.apply(this,this.shapeArgs);this.listLength=aE.length;for(aC=0;aC<aE.length;++aC){aA.push(this.CreateTag(aE[ay[aC]],ax[aC]))}this.weight&&this.Weight(aA,true)}this.taglist=aA};d.Update=function(){var aE=this.GetTags(),aD=[],ay=this.taglist,aF,aC=[],aA=[],aw,aB,av,az,ax;if(!this.shapeArgs){return this.Load()}if(aE.length){av=this.listLength=aE.length;aB=ay.length;for(az=0;az<aB;++az){aD.push(ay[az]);aA.push(az)}for(az=0;az<av;++az){for(ax=0,aF=0;ax<aB;++ax){if(ay[ax].EqualTo(aE[az])){this.UpdateTag(aD[ax],aE[az]);aF=aA[ax]=-1}}if(!aF){aC.push(az)}}for(az=0,ax=0;az<aB;++az){if(aA[ax]==-1){aA.splice(ax,1)}else{++ax}}if(aA.length){ac(aA);while(aA.length&&aC.length){az=aA.shift();ax=aC.shift();aD[az]=this.CreateTag(aE[ax])}aA.sort(function(j,i){return j-i});while(aA.length){aD.splice(aA.pop(),1)}}ax=aD.length/(aC.length+1);az=0;while(aC.length){aD.splice(V(++az*ax),0,this.CreateTag(aE[aC.shift()]))}this.shapeArgs[0]=av=aD.length;aw=this.shape.apply(this,this.shapeArgs);for(az=0;az<av;++az){aD[az].position=new U(aw[az][0],aw[az][1],aw[az][2])}this.weight&&this.Weight(aD)}this.taglist=aD};d.SetShadow=function(i){i.shadowBlur=this.shadowBlur;i.shadowOffsetX=this.shadowOffset[0];i.shadowOffsetY=this.shadowOffset[1]};d.Draw=function(aF){if(this.paused){return}var az=this.canvas,ax=az.width,aE=az.height,aH=0,aw=(aF-this.time)*this.interval/1000,aD=ax/2+this.offsetX,aC=aE/2+this.offsetY,aL=this.ctxt,aB,aM,aJ,av=-1,ay=this.taglist,aI=ay.length,j=this.frontSelect,aG=(this.centreFunc==Y),aA;this.time=aF;if(this.frozen&&this.drawn){return this.Animate(ax,aE,aw)}aA=this.AnimateFixed();aL.setTransform(1,0,0,1,0,0);this.active=null;for(aJ=0;aJ<aI;++aJ){ay[aJ].Calc(this.transform,this.fixedAlpha)}ay=n(ay,function(aN,i){return i.z-aN.z});for(aJ=0;aJ<aI;++aJ){aM=this.mx>=0&&this.my>=0&&this.taglist[aJ].CheckActive(aL,aD,aC);if(aM&&aM.sc>aH&&(!j||aM.z<=0)){aB=aM;av=aJ;aB.tag=this.taglist[aJ];aH=aM.sc}}this.active=aB;this.txtOpt||(this.shadow&&this.SetShadow(aL));aL.clearRect(0,0,ax,aE);for(aJ=0;aJ<aI;++aJ){if(!aG&&ay[aJ].z<=0){try{this.centreFunc(aL,ax,aE,aD,aC)}catch(aK){alert(aK);this.centreFunc=Y}aG=true}if(!(aB&&aB.tag==ay[aJ]&&aB.PreDraw(aL,ay[aJ],aD,aC))){ay[aJ].Draw(aL,aD,aC)}aB&&aB.tag==ay[aJ]&&aB.PostDraw(aL)}if(this.freezeActive&&aB){this.Freeze()}else{this.UnFreeze();this.drawn=(aI==this.listLength)}if(this.fixedCallback){this.fixedCallback(this,this.fixedCallbackTag);this.fixedCallback=null}aA||this.Animate(ax,aE,aw);aB&&aB.LastDraw(aL);az.style.cursor=aB?this.activeCursor:"";this.Tooltip(aB,this.taglist[av])};d.TooltipNone=function(){};d.TooltipNative=function(j,i){this.canvas.title=j&&i.title?i.title:""};d.TooltipDiv=function(ax,j){var i=this,aw=i.ttdiv.style,ay=i.canvas.id,av="none";if(ax&&j.title){if(j.title!=i.ttdiv.innerHTML){aw.display=av}i.ttdiv.innerHTML=j.title;j.title=i.ttdiv.innerHTML;if(aw.display==av&&!i.tttimer){i.tttimer=setTimeout(function(){var az=r(ay);aw.display="block";aw.left=az.x+i.mx+"px";aw.top=az.y+i.my+24+"px";i.tttimer=null},i.tooltipDelay)}}else{aw.display=av}};d.Transform=function(ay,i,aA){if(i||aA){var j=w(i),az=l(i),aB=w(aA),ax=l(aA),av=new k([ax,0,aB,0,1,0,-aB,0,ax]),aw=new k([1,0,0,0,az,-j,0,j,az]);ay.transform=ay.transform.mul(av.mul(aw))}};d.AnimateFixed=function(){var av,j,ax,i,aw;if(this.fadeIn){j=T()-this.startTime;if(j>=this.fadeIn){this.fadeIn=0;this.fixedAlpha=1}else{this.fixedAlpha=j/this.fadeIn}}if(this.fixedAnim){if(!this.fixedAnim.transform){this.fixedAnim.transform=this.transform}av=this.fixedAnim,j=T()-av.t0,ax=av.angle,i,aw=this.animTiming(av.t,j);this.transform=av.transform;if(j>=av.t){this.fixedCallbackTag=av.tag;this.fixedCallback=av.cb;this.fixedAnim=this.yaw=this.pitch=0}else{ax*=aw}i=k.Rotation(ax,av.axis);this.transform=this.transform.mul(i);return(this.fixedAnim!=0)}return false};d.AnimatePosition=function(av,ay,aw){var j=this,i=j.mx,aA=j.my,ax,az;if(!j.frozen&&i>=0&&aA>=0&&i<av&&aA<ay){ax=j.maxSpeed,az=j.reverse?-1:1;j.lx||(j.yaw=az*aw*((ax*2*i/av)-ax));j.ly||(j.pitch=az*aw*-((ax*2*aA/ay)-ax));j.initial=null}else{if(!j.initial){if(j.frozen&&!j.freezeDecel){j.yaw=j.pitch=0}else{j.Decel(j)}}}this.Transform(j,j.pitch,j.yaw)};d.AnimateDrag=function(j,ax,aw){var i=this,av=100*aw*i.maxSpeed/i.max_radius/i.zoom;if(i.dx||i.dy){i.lx||(i.yaw=i.dx*av/i.stretchX);i.ly||(i.pitch=i.dy*-av/i.stretchY);i.dx=i.dy=0;i.initial=null}else{if(!i.initial){i.Decel(i)}}this.Transform(i,i.pitch,i.yaw)};d.Freeze=function(){if(!this.frozen){this.preFreeze=[this.yaw,this.pitch];this.frozen=1;this.drawn=0}};d.UnFreeze=function(){if(this.frozen){this.yaw=this.preFreeze[0];this.pitch=this.preFreeze[1];this.frozen=0}};d.Decel=function(i){var av=i.minSpeed,aw=aa(i.yaw),j=aa(i.pitch);if(!i.lx&&aw>av){i.yaw=aw>i.z0?i.yaw*i.decel:0}if(!i.ly&&j>av){i.pitch=j>i.z0?i.pitch*i.decel:0}};d.Zoom=function(i){this.z2=this.z1*(1/i);this.drawn=0};d.Clicked=function(av){var i=this.active;try{if(i&&i.tag){if(this.clickToFront===false||this.clickToFront===null){i.tag.Clicked(av)}else{this.TagToFront(i.tag,this.clickToFront,function(){i.tag.Clicked(av)})}}}catch(j){}};d.Wheel=function(j){var av=this.zoom+this.zoomStep*(j?1:-1);this.zoom=at(this.zoomMax,I(this.zoomMin,av));this.Zoom(this.zoom)};d.BeginDrag=function(i){this.down=M(i,this.canvas);i.cancelBubble=true;i.returnValue=false;i.preventDefault&&i.preventDefault()};d.Drag=function(ax,aw){if(this.dragControl&&this.down){var av=this.dragThreshold*this.dragThreshold,j=aw.x-this.down.x,i=aw.y-this.down.y;if(this.dragging||j*j+i*i>av){this.dx=j;this.dy=i;this.dragging=1;this.down=aw}}};d.EndDrag=function(){var i=this.dragging;this.dragging=this.down=null;return i};d.Pause=function(){this.paused=true};d.Resume=function(){this.paused=false};d.FindTag=function(av){if(!aj(av)){return null}aj(av.index)&&(av=av.index);if(!v(av)){return this.taglist[av]}var aw,ax,j;if(aj(av.id)){aw="id",ax=av.id}else{if(aj(av.text)){aw="innerText",ax=av.text}}for(j=0;j<this.taglist.length;++j){if(this.taglist[j].a[aw]==ax){return this.taglist[j]}}};d.RotateTag=function(aC,av,aB,i,az){var aA=aC.xformed,ax=new U(aA.x,aA.y,aA.z),aw=K(aB,av),j=ax.angle(aw),ay=ax.cross(aw).unit();if(j==0){this.fixedCallbackTag=aC;this.fixedCallback=az}else{this.fixedAnim={angle:-j,axis:ay,t:i,t0:T(),cb:az,tag:aC}}};d.TagToFront=function(i,j,av){this.RotateTag(i,0,0,j,av)};x.Start=function(av,i,j){x.tc[av]=new x(av,i,j)};function ak(i,j){x.tc[j]&&x.tc[j][i]()}x.Linear=function(i,j){return j/i};x.Smooth=function(i,j){return 0.5-l(j*Math.PI/i)/2};x.Pause=function(i){ak("Pause",i)};x.Resume=function(i){ak("Resume",i)};x.Reload=function(i){ak("Load",i)};x.Update=function(i){ak("Update",i)};x.TagToFront=function(j,i){if(!v(i)){return false}i.lat=i.lng=0;return x.RotateTag(j,i)};x.RotateTag=function(av,i){if(!v(i)){return false}if(x.tc[av]){if(isNaN(i.time)){i.time=500}var j=x.tc[av].FindTag(i);if(j){x.tc[av].RotateTag(j,i.lat,i.lng,i.time,i.callback);return true}}return false};x.NextFrame=function(i){var j=window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;x.NextFrame=j?x.NextFrameRAF:x.NextFrameTimeout;x.NextFrame(i)};x.NextFrameRAF=function(){requestAnimationFrame(t)};x.NextFrameTimeout=function(i){setTimeout(t,i)};x.tc={};x.options={z1:20000,z2:20000,z0:0.0002,freezeActive:false,freezeDecel:false,activeCursor:"pointer",pulsateTo:1,pulsateTime:3,reverse:false,depth:0.5,maxSpeed:0.05,minSpeed:0,decel:0.95,interval:20,minBrightness:0.1,maxBrightness:1,outlineColour:"#ffff99",outlineThickness:2,outlineOffset:5,outlineMethod:"outline",textColour:"#ff99ff",textHeight:15,textFont:"Helvetica, Arial, sans-serif",shadow:"#000",shadowBlur:0,shadowOffset:[0,0],initial:null,hideTags:true,zoom:1,weight:false,weightMode:"size",weightFrom:null,weightSize:1,weightSizeMin:null,weightSizeMax:null,weightGradient:{0:"#f00",0.33:"#ff0",0.66:"#0f0",1:"#00f"},txtOpt:true,txtScale:2,frontSelect:false,wheelZoom:true,zoomMin:0.3,zoomMax:3,zoomStep:0.05,shape:"sphere",lock:null,tooltip:null,tooltipDelay:300,tooltipClass:"tctooltip",radiusX:1,radiusY:1,radiusZ:1,stretchX:1,stretchY:1,offsetX:0,offsetY:0,shuffleTags:false,noSelect:false,noMouse:false,imageScale:1,paused:false,dragControl:false,dragThreshold:4,centreFunc:Y,splitWidth:0,animTiming:"Smooth",clickToFront:false,fadeIn:0};for(ao in x.options){x[ao]=x.options[ao]}window.TagCanvas=x;G("load",function(){x.loaded=1},window);x.Stop=function(y){delete c[y];delete x.tc[y]}})();
